# Visual Regression Service

> Visual regression testing for WebdriverIO

Based on the work of Jan-Andr√© Zinser on [wdio-visual-regression-service](https://github.com/zinserjan/wdio-visual-regression-service) and [wdio-screenshot](https://github.com/zinserjan/wdio-screenshot)

## Installation

The wdio-visual-regression-service should be installed as a dev-dependency:

```sh
$ npm install @cerner/terra-functional-testing --save-dev
```

## Configuration
Setup wdio-visual-regression-service by adding `visual-regression` to the service section of your WebdriverIO config and define your desired comparison strategy in the service options.

```js
// wdio.conf.js
const VisualRegressionService = require('@cerner/terra-functional-testing/lib/services/wdio-visual-regression-service');

exports.config = {
  // ...
  services: [
    [
      VisualRegressionService,
      {
        locale: 'en',
        theme: 'orion-fusion-theme',
      }
    ]
  ],
  // ...
};
```

### Options
Under the key `visualRegression` in your wdio.config.js you can pass a configuration object with the following structure:

* **baseScreenshotDir** `String` ( default: process.cwd() ) <br />
pass in a string with the custom base output directory screenshots should be saved to.

* **formFactor** `String` ( default: undefined ) <br />
the terra viewport size the test runner is testing against. This is used to categorizes screenshots by viewport size.

* **locale** `String` ( default: 'en' ) <br />
the locale the test runner is testing against. This is used to categorizes screenshots by locale.

* **theme** `String` ( default: 'terra-default-theme' ) <br />
the theme the test runner is testing against. This is used to categorizes screenshots by theme.

* **ignoreComparison** `String`  ( default: nothing ) <br />
pass in a string with value of `nothing` , `colors` or `antialiasing` to adjust the comparison method of node-resemble-js.

* **misMatchTolerance** `Number`  ( default: 0.01 ) <br />
number between 0 and 100 that defines the degree of mismatch to consider two images as identical, increasing this value will decrease test coverage.

* **viewportChangePause**  `Number`  ( default: 100 ) <br />
wait x milliseconds after viewport change. It can take a while for the browser to re-paint. This could lead to rendering issues and produces inconsistent results between runs.

* **viewports** `Object[{ width: Number, height: Number }]`  ( default: *[current-viewport]* ) (**desktop only**) <br />
   all screenshots will be taken in different viewport dimensions (e.g. for responsive design tests)

* **orientations** `String[] {landscape, portrait}`  ( default: *[current-orientation]* ) (**mobile only**) <br />
    all screenshots will be taken in different screen orientations (e.g. for responsive design tests)

### Compare Methods
wdio-visual-regression-service allows the usage of different screenshot comparison methods.

#### VisualRegressionCompare.LocalCompare
The *LocalCompare* method captures screenshots on your computer and compares a reference screenshot against the latest (current) screenshots caputred in the test run. If a mismatch occurs, a diff screenshot will be outputed. This is the compare method used by the VisualRegressionService.

The screenshot naming pattern is as follows:

```js
baseScreenshotDir/test_spec_directory/test_spec_name/__snapshots__/(reference|latest|diff)/theme/locale/browserName_terraViewportName/screenshot.png
```

You can pass the following options to it's constructor as object:

* **baseScreenshotDir** `String` ( default: process.cwd() ) <br />
pass in a string with the custom base output directory screenshots should be saved to.

* **formFactor** `String` ( default: undefined ) <br />
the terra viewport size the test runner is testing against. This is used to categorizes screenshots by viewport size.

* **locale** `String` ( default: 'en' ) <br />
the locale the test runner is testing against. This is used to categorizes screenshots by locale.

* **theme** `String` ( default: 'terra-default-theme' ) <br />
the theme the test runner is testing against. This is used to categorizes screenshots by theme.

* **ignoreComparison** `String`  ( default: 'nothing' ) <br />
pass in a string with value of `nothing` , `colors` or `antialiasing` to adjust the comparison method of node-resemble-js.

* **misMatchTolerance** `Number`  ( default: 0.01 ) <br />
number between 0 and 100 that defines the degree of mismatch to consider two images as identical, increasing this value will decrease test coverage.

#### VisualRegressionCompare.SaveScreenshot
This method is a stripped variant of `VisualRegressionCompare.LocalCompare` to capture only screenshots. This is quite useful when you just want to create reference screenshots and overwrite the previous one without diffing.

You can pass the following options to it's constructor as object:

* **screenshotName** `Function` <br />
pass in a function that returns the filename for the current screenshot. Function receives a *context* object as first parameter with all relevant information about the command.

## Usage
wdio-visual-regression-service enhances an WebdriverIO instance with the following commands:
* `browser.checkViewport([{options}]);`
* `browser.checkDocument([{options}]);`
* `browser.checkElement(elementSelector, [{options}]);`


All of these provide options that will help you to capture screenshots in different dimensions or to exclude irrelevant parts (e.g. content). The following options are
available:

* **exclude** `String[]|Object[]` (**not yet implemented**)<br>
  exclude frequently changing parts of your screenshot, you can either pass all kinds of different [WebdriverIO selector strategies](http://webdriver.io/guide/usage/selectors.html)
  that queries one or multiple elements or you can define x and y values which stretch a rectangle or polygon

* **hide** `Object[]` <br />
  hides all elements queried by all kinds of different [WebdriverIO selector strategies](http://webdriver.io/guide/usage/selectors.html) (via `visibility: hidden`)

* **remove** `Object[]` <br />
  removes all elements queried by all kinds of different [WebdriverIO selector strategies](http://webdriver.io/guide/usage/selectors.html) (via `display: none`)

* **viewports** `Object[{ width: Number, height: Number }]` (**desktop only**)<br>
     Overrides the global *viewports* value for this command. All screenshots will be taken in different viewport dimensions (e.g. for responsive design tests)

* **orientations** `String[] {landscape, portrait}` (**mobile only**)<br>
    Overrides the global *orientations* value for this command. All screenshots will be taken in different screen orientations (e.g. for responsive design tests)

* **misMatchTolerance** `Number` <br />
    Overrides the global *misMatchTolerance* value for this command. Pass in a number between 0 and 100 that defines the degree of mismatch to consider two images as identical.

* **ignoreComparison** `String` <br />
    Overrides the global *ignoreComparison* value for this command. Pass in a string with value of `nothing` , `colors` or `antialiasing` to adjust the comparison method.

* **viewportChangePause**  `Number` <br />
    Overrides the global *viewportChangePause* value for this command. Wait x milliseconds after viewport change.

